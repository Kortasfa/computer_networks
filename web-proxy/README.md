# HTTP Web Proxy с кэшированием

## Описание

HTTP Web Proxy - это прокси-сервер, реализованный на C++, который выступает посредником между клиентом (браузером) и веб-серверами. Прокси кэширует полученный контент на диске и обеспечивает повторный доступ к данным без обращения к сети.

## Архитектура

### Основные компоненты

1. **Socket (RAII wrapper)**: Класс для безопасного управления сокетами с автоматическим закрытием в деструкторе.

2. **ProxyServer**: Основной класс прокси-сервера, который включает:
   - Прием входящих соединений от клиентов
   - Парсинг HTTP запросов (GET и POST)
   - Управление кэшем на диске
   - Пересылку запросов на целевые серверы
   - Многопоточную обработку клиентов

3. **ParsedRequest**: Структура для хранения распарсенных данных HTTP запроса.

4. **CacheEntry**: Структура для метаданных кэшированных объектов.

### Алгоритм кэширования

1. **Генерация ключа кэша**: Ключ формируется из хоста, порта и пути запроса (например, `example.com:80/index.html`).

2. **Проверка кэша**: При получении GET запроса прокси проверяет наличие объекта в локальном кэше на диске.

3. **Cache Hit**: Если объект найден и имеет статус 200, прокси отправляет его клиенту напрямую из файла без обращения к серверу.

4. **Cache Miss**: Если объекта нет в кэше:
   - Прокси подключается к целевому веб-серверу
   - Перенаправляет запрос
   - Получает ответ
   - Сохраняет его в кэш (если статус 200)
   - Отправляет клиенту

5. **Обработка ошибок**: Прокси не кэширует ошибки 404 и другие неуспешные ответы.

### Структура кэша

- Каждый кэшированный объект сохраняется в файл с именем, основанным на ключе кэша
- Метаданные (статус код, время модификации) сохраняются в отдельный файл `.meta`
- Кэш хранится в директории `./cache` (по умолчанию)

### Многопоточность

- Каждый клиент обрабатывается в отдельном потоке (`std::thread`)
- Используются мьютексы для синхронизации доступа к:
  - Логированию (`logMutex_`)
  - Кэшу (`cacheMutex_`)
  - Статистике (`statsMutex_`)

### Безопасность

- Использование RAII для управления ресурсами (сокеты закрываются автоматически)
- Безопасная обработка строк через `std::string` и `std::vector`
- Проверка всех системных вызовов на наличие ошибок
- Санитизация имен файлов для предотвращения path traversal атак

## Компиляция

```bash
make
```

## Запуск

```bash
./proxy_server [port] [cache_directory]
```

Параметры:
- `port` - порт для прослушивания (по умолчанию: 8080)
- `cache_directory` - директория для кэша (по умолчанию: ./cache)

Пример:
```bash
./proxy_server 8080 ./cache
```

## Настройка браузера

### Firefox
1. Откройте Настройки → Сеть → Настройки
2. Выберите "Ручная настройка прокси"
3. Укажите:
   - HTTP прокси: `localhost`
   - Порт: `8080`

### Chrome/Chromium
Запустите с параметрами:
```bash
google-chrome --proxy-server="http://localhost:8080"
```

### Safari (macOS)
**Важно**: Safari использует системные настройки прокси.

1. Откройте **Системные настройки** → **Сеть**
2. Выберите ваше активное подключение (Wi-Fi или Ethernet)
3. Нажмите **Дополнительно...**
4. Перейдите на вкладку **Прокси**
5. Включите **Веб-прокси (HTTP)**
6. Укажите:
   - **Сервер прокси**: `127.0.0.1` или `localhost`
   - **Порт**: `8080`
7. Нажмите **OK** и **Применить**

**Примечание**: Для HTTPS сайтов прокси не поддерживается (требуется реализация CONNECT метода). Используйте HTTP сайты для тестирования.

## Логирование и примеры работы

Прокси выводит в консоль информацию о каждой операции:
- Время получения запроса
- Метод и URL запроса
- Статус кэша (Cache Hit/Miss)
- Ошибки при работе

### Пример 1: Первый запрос (Cache Miss)

При первом обращении к сайту прокси получает данные с сервера и сохраняет в кэш:

```
[2024-12-24 11:45:30] Proxy server started on port 8080
[2024-12-24 11:45:30] Cache directory: ./cache
[2024-12-24 11:45:35] Received request from client (512 bytes)
[2024-12-24 11:45:35] Request line: GET http://example.com/ HTTP/1.1
[2024-12-24 11:45:35] Request: GET http://example.com:80/
[2024-12-24 11:45:35] Cache MISS: example.com:80/
[2024-12-24 11:45:36] Response sent to client
```

### Пример 2: Повторный запрос (Cache Hit)

При повторном обращении к тому же ресурсу прокси использует кэш, что значительно ускоряет загрузку:

```
[2024-12-24 11:45:40] Received request from client (512 bytes)
[2024-12-24 11:45:40] Request line: GET http://example.com/ HTTP/1.1
[2024-12-24 11:45:40] Request: GET http://example.com:80/
[2024-12-24 11:45:40] Cache HIT: example.com:80/
[2024-12-24 11:45:40] Response sent to client
```

**Важно**: Обратите внимание на разницу во времени:
- Cache MISS: запрос занял ~1 секунду (сетевое обращение)
- Cache HIT: запрос обработан мгновенно (чтение с диска)

### Пример 3: Работа с несколькими сайтами

Прокси может одновременно обрабатывать запросы к разным сайтам:

```
[2024-12-24 11:46:10] Received request from client (485 bytes)
[2024-12-24 11:46:10] Request line: GET http://httpbin.org/get HTTP/1.1
[2024-12-24 11:46:10] Request: GET http://httpbin.org:80/get
[2024-12-24 11:46:10] Cache MISS: httpbin.org:80/get
[2024-12-24 11:46:11] Response sent to client
[2024-12-24 11:46:15] Received request from client (512 bytes)
[2024-12-24 11:46:15] Request line: GET http://example.com/ HTTP/1.1
[2024-12-24 11:46:15] Request: GET http://example.com:80/
[2024-12-24 11:46:15] Cache HIT: example.com:80/
[2024-12-24 11:46:15] Response sent to client
[2024-12-24 11:46:20] Received request from client (485 bytes)
[2024-12-24 11:46:20] Request line: GET http://httpbin.org/get HTTP/1.1
[2024-12-24 11:46:20] Request: GET http://httpbin.org:80/get
[2024-12-24 11:46:20] Cache HIT: httpbin.org:80/get
[2024-12-24 11:46:20] Response sent to client
```

### Пример 4: Обработка ошибок

Прокси корректно обрабатывает ошибки и не кэширует неуспешные ответы:

```
[2024-12-24 11:47:00] Received request from client (498 bytes)
[2024-12-24 11:47:00] Request line: GET http://example.com/nonexistent.html HTTP/1.1
[2024-12-24 11:47:00] Request: GET http://example.com:80/nonexistent.html
[2024-12-24 11:47:00] Cache MISS: example.com:80/nonexistent.html
[2024-12-24 11:47:01] Response sent to client
```

Обратите внимание: ответ 404 не был закэширован, поэтому при повторном запросе прокси снова обратится к серверу.

### Демонстрация ускорения загрузки

Для демонстрации эффективности кэширования можно использовать `time`:

```bash
# Первый запрос (Cache Miss) - медленнее
$ time curl -x localhost:8080 http://example.com > /dev/null
real    0m1.234s
user    0m0.012s
sys     0m0.008s

# Второй запрос (Cache Hit) - значительно быстрее
$ time curl -x localhost:8080 http://example.com > /dev/null
real    0m0.015s
user    0m0.008s
sys     0m0.004s
```

Разница во времени выполнения демонстрирует эффективность кэширования: второй запрос выполняется в ~80 раз быстрее.

## Статистика

Прокси ведет статистику работы:
- Общее количество запросов
- Количество попаданий в кэш (Cache Hits)
- Количество промахов в кэш (Cache Misses)
- Количество ошибок

## Особенности реализации

- **Поддержка HTTP GET и POST**: Прокси корректно обрабатывает оба метода
- **Многопоточность**: Одновременная обработка множества клиентов
- **Безопасное кэширование**: Ошибки 404 не кэшируются
- **RAII**: Автоматическое управление ресурсами
- **Валидация**: Проверка всех системных вызовов

## Скриншоты для отчета

Для демонстрации работы прокси-сервера рекомендуется подготовить следующие скриншоты:

### 1. Настройки браузера

**Safari (macOS):**
- Системные настройки → Сеть → [Ваше подключение] → Дополнительно → Прокси
- Скриншот должен показывать включенный "Веб-прокси (HTTP)" с указанием:
  - Сервер прокси: `127.0.0.1` или `localhost`
  - Порт: `8080`

**Firefox:**
- Настройки → Сеть → Настройки → Ручная настройка прокси
- Скриншот должен показывать:
  - HTTP прокси: `localhost`
  - Порт: `8080`

### 2. Успешная загрузка веб-страницы

- Откройте любой HTTP сайт (например, `http://example.com`) через прокси
- Скриншот должен показывать успешно загруженную страницу в браузере
- В адресной строке должен быть виден URL сайта

### 3. Логи сервера, демонстрирующие Cache Hit

Запустите прокси-сервер и выполните следующие шаги:

1. **Первый запрос (Cache Miss):**
   ```bash
   curl -x localhost:8080 http://example.com
   ```
   В логах должно появиться: `Cache MISS: example.com:80/`

2. **Второй запрос (Cache Hit):**
   ```bash
   curl -x localhost:8080 http://example.com
   ```
   В логах должно появиться: `Cache HIT: example.com:80/`

**Пример логов (подробнее в example_logs.txt):**
```
[2024-12-24 11:45:30] Proxy server started on port 8080
[2024-12-24 11:45:30] Cache directory: ./cache
[2024-12-24 11:45:35] Received request from client (512 bytes)
[2024-12-24 11:45:35] Request line: GET http://example.com/ HTTP/1.1
[2024-12-24 11:45:35] Request: GET http://example.com:80/
[2024-12-24 11:45:35] Cache MISS: example.com:80/
[2024-12-24 11:45:36] Response sent to client
[2024-12-24 11:45:40] Received request from client (512 bytes)
[2024-12-24 11:45:40] Request line: GET http://example.com/ HTTP/1.1
[2024-12-24 11:45:40] Request: GET http://example.com:80/
[2024-12-24 11:45:40] Cache HIT: example.com:80/
[2024-12-24 11:45:40] Response sent to client
```

### 4. Дополнительно: Проверка кэша на диске

Можно также показать содержимое директории кэша:

```bash
ls -lh cache/
```

Это демонстрирует, что прокси действительно сохраняет данные на диск.

## Очистка

```bash
make clean
```

Удаляет скомпилированный бинарник и директорию кэша.

